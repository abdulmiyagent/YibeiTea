generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Address {
  id         String   @id
  userId     String
  name       String
  street     String
  city       String
  postalCode String
  country    String   @default("BE")
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Allergen {
  id           String                @id
  code         String                @unique
  translations AllergenTranslation[]
  products     ProductAllergen[]
}

model AllergenTranslation {
  id         String   @id
  allergenId String
  locale     String
  name       String
  allergen   Allergen @relation(fields: [allergenId], references: [id], onDelete: Cascade)

  @@unique([allergenId, locale])
}

model Category {
  id           String                @id
  slug         String                @unique
  sortOrder    Int                   @default(0)
  isActive     Boolean               @default(true)
  imageUrl     String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime
  translations CategoryTranslation[]
  products     Product[]
}

model CategoryTranslation {
  id          String   @id
  categoryId  String
  locale      String
  name        String
  description String?
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, locale])
}

model CustomizationGroup {
  id        String               @id
  type      CustomizationType    @unique
  isActive  Boolean              @default(true)
  sortOrder Int                  @default(0)
  createdAt DateTime             @default(now())
  updatedAt DateTime
  values    CustomizationValue[]
}

model CustomizationOption {
  id            String                     @id
  productId     String
  type          CustomizationType
  priceModifier Decimal                    @default(0) @db.Decimal(10, 2)
  product       Product                    @relation(fields: [productId], references: [id], onDelete: Cascade)
  translations  CustomizationTranslation[]
}

model CustomizationTranslation {
  id                    String              @id
  customizationOptionId String
  locale                String
  name                  String
  customizationOption   CustomizationOption @relation(fields: [customizationOptionId], references: [id], onDelete: Cascade)

  @@unique([customizationOptionId, locale])
}

model CustomizationValue {
  id            String                          @id
  groupId       String
  value         String
  priceModifier Decimal                         @default(0) @db.Decimal(10, 2)
  isDefault     Boolean                         @default(false)
  isAvailable   Boolean                         @default(true)
  sortOrder     Int                             @default(0)
  group         CustomizationGroup              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  translations  CustomizationValueTranslation[]

  @@unique([groupId, value])
}

model CustomizationValueTranslation {
  id                 String             @id
  valueId            String
  locale             String
  label              String
  customizationValue CustomizationValue @relation(fields: [valueId], references: [id], onDelete: Cascade)

  @@unique([valueId, locale])
}

model Favorite {
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, productId])
}

model LoyaltyTransaction {
  id          String                 @id
  userId      String
  orderId     String?
  type        LoyaltyTransactionType
  points      Int
  description String?
  createdAt   DateTime               @default(now())
  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Order {
  id              String        @id
  orderNumber     String        @unique
  userId          String?
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  molliePaymentId String?
  subtotal        Decimal       @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  pointsEarned    Int           @default(0)
  pointsRedeemed  Int           @default(0)
  pickupTime      DateTime?
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  user            User?         @relation(fields: [userId], references: [id])
  items           OrderItem[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([customerEmail])
}

model OrderItem {
  id             String  @id
  orderId        String
  productId      String
  quantity       Int
  unitPrice      Decimal @db.Decimal(10, 2)
  totalPrice     Decimal @db.Decimal(10, 2)
  customizations Json?
  order          Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Product {
  id                      String                       @id
  slug                    String                       @unique
  categoryId              String
  price                   Decimal                      @db.Decimal(10, 2)
  imageUrl                String?
  isAvailable             Boolean                      @default(true)
  isFeatured              Boolean                      @default(false)
  sortOrder               Int                          @default(0)
  calories                Int?
  caffeine                Boolean                      @default(true)
  vegan                   Boolean                      @default(false)
  allowSugarCustomization Boolean                      @default(true)
  allowIceCustomization   Boolean                      @default(true)
  allowToppings           Boolean                      @default(true)
  createdAt               DateTime                     @default(now())
  updatedAt               DateTime
  customizationOptions    CustomizationOption[]
  favorites               Favorite[]
  orderItems              OrderItem[]
  category                Category                     @relation(fields: [categoryId], references: [id])
  allergens               ProductAllergen[]
  customizationConfigs    ProductCustomizationConfig[]
  translations            ProductTranslation[]

  @@index([categoryId])
  @@index([isAvailable])
  @@index([isFeatured])
}

model ProductAllergen {
  productId  String
  allergenId String
  allergen   Allergen @relation(fields: [allergenId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, allergenId])
}

model ProductCustomizationConfig {
  id        String            @id
  productId String
  type      CustomizationType
  required  Boolean           @default(false)
  product   Product           @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, type])
}

model ProductTranslation {
  id          String  @id
  productId   String
  locale      String
  name        String
  description String
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
}

model PromoCode {
  id             String       @id
  code           String       @unique
  discountType   DiscountType
  discountValue  Decimal      @db.Decimal(10, 2)
  minOrderAmount Decimal?     @db.Decimal(10, 2)
  maxUses        Int?
  usedCount      Int          @default(0)
  validFrom      DateTime
  validUntil     DateTime
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
}

model Review {
  id         String   @id
  userId     String
  rating     Int
  comment    String?
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Reward {
  id           String              @id
  slug         String              @unique
  pointsCost   Int
  isAvailable  Boolean             @default(true)
  rewardType   String
  rewardValue  Decimal             @db.Decimal(10, 2)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime
  translations RewardTranslation[]
}

model RewardTranslation {
  id          String @id
  rewardId    String
  locale      String
  name        String
  description String
  reward      Reward @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  @@unique([rewardId, locale])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model StoreSettings {
  id                  String   @id @default("default")
  openingHours        Json
  minPickupMinutes    Int      @default(15)
  maxAdvanceOrderDays Int      @default(7)
  pointsPerEuro       Int      @default(10)
  socialLinks         Json?    // Array of { platform, href, isActive }
  updatedAt           DateTime
}

model Topping {
  id           String               @id
  slug         String               @unique
  price        Decimal              @db.Decimal(10, 2)
  isAvailable  Boolean              @default(true)
  sortOrder    Int                  @default(0)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime
  translations ToppingTranslation[]
}

model ToppingTranslation {
  id        String  @id
  toppingId String
  locale    String
  name      String
  topping   Topping @relation(fields: [toppingId], references: [id], onDelete: Cascade)

  @@unique([toppingId, locale])
}

model User {
  id                  String               @id
  name                String?
  email               String               @unique
  emailVerified       DateTime?
  image               String?
  phone               String?
  dateOfBirth         DateTime?
  role                UserRole             @default(USER)
  twoFactorSecret     String?
  twoFactorEnabled    Boolean              @default(false)
  twoFactorVerified   DateTime?
  loyaltyPoints       Int                  @default(0)
  loyaltyTier         LoyaltyTier          @default(BRONZE)
  preferredLanguage   String               @default("nl")
  newsletterOptIn     Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  accounts            Account[]
  addresses           Address[]
  favorites           Favorite[]
  loyaltyTransactions LoyaltyTransaction[]
  orders              Order[]
  reviews             Review[]
  sessions            Session[]
}

// Newsletter subscriber (for non-users who subscribe via footer)
model NewsletterSubscriber {
  id              String                    @id @default(cuid())
  email           String                    @unique
  name            String?
  locale          String                    @default("nl")
  status          NewsletterStatus          @default(PENDING)
  consentAt       DateTime?
  consentIp       String?
  unsubscribedAt  DateTime?
  unsubscribeToken String                   @unique @default(cuid())
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
}

// Newsletter campaign tracking
model NewsletterCampaign {
  id          String   @id @default(cuid())
  subject     String
  content     String   @db.Text
  sentAt      DateTime?
  sentCount   Int      @default(0)
  openedCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum CustomizationType {
  SUGAR_LEVEL
  ICE_LEVEL
  SIZE
  MILK_TYPE
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
}

enum LoyaltyTransactionType {
  EARN
  REDEEM
  BONUS
  EXPIRE
  ADJUSTMENT
}

enum OrderStatus {
  PENDING
  PAID
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum NewsletterStatus {
  PENDING
  ACTIVE
  UNSUBSCRIBED
}
